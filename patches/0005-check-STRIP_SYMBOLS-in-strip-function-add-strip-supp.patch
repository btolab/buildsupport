From 3977ae4c639e055ec375824d085f7e717d28f9fe Mon Sep 17 00:00:00 2001
From: Jeffrey Clark <dude@zaplabs.com>
Date: Mon, 2 Nov 2015 21:08:15 -0600
Subject: [PATCH 05/13] check STRIP_SYMBOLS in strip function, add strip
 support for osx builds

Signed-off-by: Jeffrey Clark <dude@zaplabs.com>
---
 scripts/genie.lua       |  5 +----
 scripts/src/osd/sdl.lua |  4 ++++
 scripts/src/tools.lua   | 31 +++++++++++++++++++++++++++++++
 scripts/toolchain.lua   |  8 ++++++++
 4 files changed, 44 insertions(+), 4 deletions(-)

diff --git a/scripts/genie.lua b/scripts/genie.lua
index e87d854..4c4fa93 100644
--- a/scripts/genie.lua
+++ b/scripts/genie.lua
@@ -1291,10 +1291,7 @@ else
 	startproject (_OPTIONS["subtarget"])
 end 
 mainProject(_OPTIONS["target"],_OPTIONS["subtarget"])
-
-if (_OPTIONS["STRIP_SYMBOLS"]=="1") then
-	strip()
-end
+strip()
 
 if _OPTIONS["with-tools"] then
 	group "tools"
diff --git a/scripts/src/osd/sdl.lua b/scripts/src/osd/sdl.lua
index 6a63e7c..8ac53f3 100644
--- a/scripts/src/osd/sdl.lua
+++ b/scripts/src/osd/sdl.lua
@@ -565,6 +565,8 @@ if _OPTIONS["with-tools"] then
 				MAME_DIR .. "src/osd/sdl/SDLMain_tmpl.mm",
 			}
 		end
+
+		strip()
 end
 
 
@@ -606,4 +608,6 @@ if _OPTIONS["targetos"] == "macosx" and _OPTIONS["with-tools"] then
 		files {
 			MAME_DIR .. "src/osd/sdl/aueffectutil.mm",
 		}
+
+		strip()
 end
diff --git a/scripts/src/tools.lua b/scripts/src/tools.lua
index 1994265..c3ed265 100644
--- a/scripts/src/tools.lua
+++ b/scripts/src/tools.lua
@@ -50,6 +50,8 @@ files {
 	MAME_DIR .. "src/tools/romcmp.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- chdman
 --------------------------------------------------
@@ -104,6 +106,8 @@ files {
 	MAME_DIR .. "src/version.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- jedutil
 --------------------------------------------------
@@ -145,6 +149,8 @@ files {
 	MAME_DIR .. "src/tools/jedutil.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- unidasm
 --------------------------------------------------
@@ -201,6 +207,7 @@ files {
 	MAME_DIR .. "src/emu/emucore.cpp",
 }
 
+strip()
 
 --------------------------------------------------
 -- ldresample
@@ -255,6 +262,8 @@ files {
 	MAME_DIR .. "src/tools/ldresample.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- ldverify
 --------------------------------------------------
@@ -308,6 +317,8 @@ files {
 	MAME_DIR .. "src/tools/ldverify.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- regrep
 --------------------------------------------------
@@ -349,6 +360,8 @@ files {
 	MAME_DIR .. "src/tools/regrep.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- srcclean
 ---------------------------------------------------
@@ -390,6 +403,8 @@ files {
 	MAME_DIR .. "src/tools/srcclean.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- src2html
 --------------------------------------------------
@@ -431,6 +446,8 @@ files {
 	MAME_DIR .. "src/tools/src2html.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- split
 --------------------------------------------------
@@ -483,6 +500,8 @@ files {
 	MAME_DIR .. "src/tools/split.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- pngcmp
 --------------------------------------------------
@@ -524,6 +543,8 @@ files {
 	MAME_DIR .. "src/tools/pngcmp.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- nltool
 --------------------------------------------------
@@ -578,6 +599,8 @@ files {
 	MAME_DIR .. "src/lib/netlist/prg/nltool.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- nlwav
 --------------------------------------------------
@@ -610,6 +633,8 @@ files {
   MAME_DIR .. "src/lib/netlist/prg/nlwav.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- castool
 --------------------------------------------------
@@ -664,6 +689,8 @@ files {
 	MAME_DIR .. "src/tools/castool.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- floptool
 --------------------------------------------------
@@ -719,6 +746,8 @@ files {
 	MAME_DIR .. "src/tools/floptool.cpp",
 }
 
+strip()
+
 --------------------------------------------------
 -- imgtool
 --------------------------------------------------
@@ -822,3 +851,5 @@ files {
 	MAME_DIR .. "src/tools/imgtool/modules/bml3.cpp",
 	MAME_DIR .. "src/tools/imgtool/modules/hp48.cpp",
 }
+
+strip()
diff --git a/scripts/toolchain.lua b/scripts/toolchain.lua
index d7517e8e..0da42d1 100644
--- a/scripts/toolchain.lua
+++ b/scripts/toolchain.lua
@@ -918,6 +918,13 @@ function toolchain(_buildDir, _subDir)
 end
 
 function strip()
+	if not _OPTIONS["STRIP_SYMBOLS"] or _OPTIONS["STRIP_SYMBOLS"]=="1" then
+	configuration { "osx-*", "Release" }
+		postbuildcommands {
+			"$(SILENT) echo Stripping symbols.",
+			"$(SILENT) " .. (_OPTIONS['TOOLCHAIN'] and toolchainPrefix) .. "strip \"$(TARGET)\"",
+		}
+
 	configuration { "android-arm", "Release" }
 		postbuildcommands {
 			"$(SILENT) echo Stripping symbols.",
@@ -979,5 +986,6 @@ function strip()
 		}
 
 	configuration {} -- reset configuration
+	end
 end
 
-- 
2.4.3

