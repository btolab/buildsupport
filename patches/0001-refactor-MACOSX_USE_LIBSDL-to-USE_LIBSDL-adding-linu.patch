From 66af183c479e1b7165c893852e47d926b894be55 Mon Sep 17 00:00:00 2001
From: Jeffrey Clark <dude@zaplabs.com>
Date: Mon, 2 Nov 2015 21:16:00 -0600
Subject: [PATCH 01/11] refactor MACOSX_USE_LIBSDL to USE_LIBSDL, adding linux
 and windows support

Signed-off-by: Jeffrey Clark <dude@zaplabs.com>
---
 makefile                    |  6 ++---
 scripts/src/osd/sdl.lua     | 54 +++++++++++++++++++++++++++------------------
 scripts/src/osd/sdl_cfg.lua |  2 +-
 3 files changed, 37 insertions(+), 25 deletions(-)

diff --git a/makefile b/makefile
index a398238..4cca49e 100644
--- a/makefile
+++ b/makefile
@@ -66,7 +66,7 @@
 # SDL_INSTALL_ROOT = /opt/sdl2
 # SDL_FRAMEWORK_PATH = $(HOME)/Library/Frameworks
 # SDL_LIBVER = sdl
-# MACOSX_USE_LIBSDL = 1
+# USE_LIBSDL = 1
 # CYGWIN_BUILD = 1
 
 # TARGETOS = windows
@@ -572,8 +572,8 @@ ifdef SDL_FRAMEWORK_PATH
 PARAMS += --SDL_FRAMEWORK_PATH='$(SDL_FRAMEWORK_PATH)'
 endif
 
-ifdef MACOSX_USE_LIBSDL
-PARAMS += --MACOSX_USE_LIBSDL='$(MACOSX_USE_LIBSDL)'
+ifdef USE_LIBSDL
+PARAMS += --USE_LIBSDL='$(USE_LIBSDL)'
 endif
 
 ifdef LDOPTS
diff --git a/scripts/src/osd/sdl.lua b/scripts/src/osd/sdl.lua
index 2922c8c..c54a504 100644
--- a/scripts/src/osd/sdl.lua
+++ b/scripts/src/osd/sdl.lua
@@ -46,14 +46,20 @@ function maintargetosdoptions(_target,_subtarget)
 	end
 
 	if _OPTIONS["targetos"]=="windows" then
-		if _OPTIONS["SDL_LIBVER"]=="sdl2" then
-			links {
-				"SDL2.dll",
-			}
+		if _OPTIONS["USE_LIBSDL"]~="1" then
+			if _OPTIONS["SDL_LIBVER"]=="sdl2" then
+				links {
+					"SDL2.dll",
+				}
+			else
+				links {
+					"SDL.dll",
+				}
+			end
 		else
-			links {
-				"SDL.dll",
-			}
+			local str = backtick(sdlconfigcmd() .. " --libs | sed 's/ -lSDLmain//'")
+			addlibfromstring(str)
+			addoptionsfromstring(str)
 		end
 
 		configuration { "mingw*-gcc" }
@@ -181,16 +187,16 @@ if not _OPTIONS["SDL_FRAMEWORK_PATH"] then
 end
 
 newoption {
-	trigger = "MACOSX_USE_LIBSDL",
-	description = "Use SDL library on OS (rather than framework)",
+	trigger = "USE_LIBSDL",
+	description = "Use SDL library on OS (rather than framework/dll)",
 	allowed = {
-		{ "0",  "Use framework"  },
+		{ "0",  "Use framework/dll"  },
 		{ "1",  "Use library" },
 	},
 }
 
-if not _OPTIONS["MACOSX_USE_LIBSDL"] then
-	_OPTIONS["MACOSX_USE_LIBSDL"] = "0"
+if not _OPTIONS["USE_LIBSDL"] then
+	_OPTIONS["USE_LIBSDL"] = "0"
 end
 
 
@@ -233,7 +239,7 @@ if BASE_TARGETOS=="unix" then
 		links {
 			"Cocoa.framework",
 		}
-		if _OPTIONS["MACOSX_USE_LIBSDL"]~="1" then
+		if _OPTIONS["USE_LIBSDL"]~="1" then
 			linkoptions {
 				"-F" .. _OPTIONS["SDL_FRAMEWORK_PATH"],
 			}
@@ -247,7 +253,7 @@ if BASE_TARGETOS=="unix" then
 				}
 			end
 		else
-			local str = backtick(sdlconfigcmd() .. " --libs | sed 's/-lSDLmain//'")
+			local str = backtick(sdlconfigcmd() .. " --libs --static | sed 's/-lSDLmain//'")
 			addlibfromstring(str)
 			addoptionsfromstring(str)
 		end
@@ -458,14 +464,20 @@ if _OPTIONS["with-tools"] then
 		}
 
 		if _OPTIONS["targetos"] == "windows" then
-			if _OPTIONS["SDL_LIBVER"] == "sdl2" then
-				links {
-					"SDL2.dll",
-				}
+			if _OPTIONS["USE_LIBSDL"]~="1" then
+				if _OPTIONS["SDL_LIBVER"] == "sdl2" then
+					links {
+						"SDL2.dll",
+					}
+				else
+					links {
+						"SDL.dll",
+					}
+				end
 			else
-				links {
-					"SDL.dll",
-				}
+				local str = backtick(sdlconfigcmd() .. " --libs | sed 's/ -lSDLmain//'")
+				addlibfromstring(str)
+				addoptionsfromstring(str)
 			end
 			linkoptions{
 				"-municode",
diff --git a/scripts/src/osd/sdl_cfg.lua b/scripts/src/osd/sdl_cfg.lua
index 878a5a2..bb1a286 100644
--- a/scripts/src/osd/sdl_cfg.lua
+++ b/scripts/src/osd/sdl_cfg.lua
@@ -81,7 +81,7 @@ if BASE_TARGETOS=="unix" then
 		"SDLMAME_UNIX",
 	}
 	if _OPTIONS["targetos"]=="macosx" then
-		if _OPTIONS["MACOSX_USE_LIBSDL"]~="1" then
+		if _OPTIONS["USE_LIBSDL"]~="1" then
 			buildoptions {
 				"-F" .. _OPTIONS["SDL_FRAMEWORK_PATH"],
 			}
-- 
2.4.3

